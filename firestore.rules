rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.email == 'kleanlyspt@gmail.com' ||
              request.auth.token.email == 'admin@kleanly.co.ke' ||
              request.auth.token.email == 'test@admin.com');
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isSignedIn() { return request.auth != null; }
    function isDriver() { return isSignedIn() && request.auth.token.role == 'driver'; }

    // Helper function to check if user is the assigned driver for a delivery
    function isAssignedDriver(driverId) {
      return isAuthenticated() && 
             (request.auth.uid == driverId ||
              exists(/databases/$(database)/documents/drivers/$(driverId)) &&
              get(/databases/$(database)/documents/drivers/$(driverId)).data.email == request.auth.token.email);
    }

    // Only allow payment-related fields to change
    function onlyPaymentFieldsChanged() {
      let allowed = [
        'paymentStatus',
        'paymentMethod',
        'paymentAmount',
        'transactionId',
        'paymentUpdatedBy',
        'updatedAt',
        'lastPaymentEventAt',
        'paidAt',
        'paymentEvents'
      ];
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(allowed);
    }

    // Only allow delivery status fields to change
    function onlyDeliveryStatusChanged() {
      let allowed = [
        'status',
        'currentLocation',
        'actualPickupTime',
        'actualDeliveryTime',
        'updatedAt'
      ];
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(allowed);
    }

    // Orders collection rules - SIMPLIFIED FOR DEBUGGING
    match /orders/{orderId} {
      // ðŸ”’ ADMIN: Full access to all orders
      allow read, write, create, delete: if isAdmin();
      
      // ðŸ”§ TEMPORARY: Allow ALL authenticated users to read orders (for debugging)
      allow read: if isAuthenticated();
      
      // ðŸ‘¤ USERS: Can read and write their own orders
      allow read, write, create: if isAuthenticated() && 
                                  resource.data.userID == request.auth.uid;
      
      // ðŸšš DRIVERS: Can update payment fields only
      allow update: if isAuthenticated() && onlyPaymentFieldsChanged();
      
      // ðŸšš DRIVERS: Can update order status
      allow update: if isAuthenticated();
      
      // Allow users to create orders with their own userID
      allow create: if isAuthenticated() && 
                    request.resource.data.userID == request.auth.uid;
    }
    
    // Drivers collection rules
    match /drivers/{driverId} {
      // ðŸ”’ ADMIN: Full access to all drivers
      allow read, write, create, delete: if isAdmin();
      
      // ðŸ”§ DEVELOPMENT: Temporarily allow any authenticated user to read drivers
      allow read: if isAuthenticated();
      
      // ðŸšš DRIVERS: Can read and update their own profile
      allow read, update: if isAuthenticated() && 
                          (resource.data.email == request.auth.token.email ||
                           request.auth.uid == driverId);
      
      // Allow authenticated users to create driver accounts (for registration)
      allow create: if isAuthenticated();
    }
    
    // Delivery tracking collection - SIMPLIFIED FOR DEBUGGING
    match /deliveryTracking/{trackingId} {
      // ðŸ”’ ADMIN: Admin can read/write all tracking data
      allow read, write, create, delete: if isAdmin();
      
      // ðŸ”§ TEMPORARY: Allow ALL authenticated users full access (for debugging)
      allow read, write, create, update: if isAuthenticated();
    }
    
    // Order assignments collection for analytics
    match /orderAssignments/{assignmentId} {
      // ðŸ”’ ADMIN: Full access to assignment records
      allow read, write, create: if isAdmin();
      
      // ðŸšš DRIVERS: Can read assignments related to them
      allow read: if isAuthenticated() && 
                  resource.data.driverId != null &&
                  isAssignedDriver(resource.data.driverId);
    }
    
    // Driver earnings collection
    match /driverEarnings/{earningsId} {
      // ðŸ”’ ADMIN: Full access to all earnings records
      allow read, write, create: if isAdmin();
      
      // ðŸšš DRIVERS: Can read their own earnings
      allow read: if isAuthenticated() && 
                  resource.data.driverId != null &&
                  isAssignedDriver(resource.data.driverId);
    }
    
    // Driver shifts collection
    match /driverShifts/{shiftId} {
      // ðŸ”’ ADMIN: Full access to all shift records
      allow read, write, create: if isAdmin();
      
      // ðŸšš DRIVERS: Can read their own shifts
      allow read: if isAuthenticated() && 
                  resource.data.driverId != null &&
                  isAssignedDriver(resource.data.driverId);
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // ðŸ”’ ADMIN: Full access to all notifications
      allow read, write, create, delete: if isAdmin();
      
      // ðŸšš DRIVERS: Can read notifications sent to them
      allow read, update: if isAuthenticated() && 
                          resource.data.driverId != null &&
                          isAssignedDriver(resource.data.driverId);
      
      // ðŸ‘¤ USERS: Can read notifications sent to them
      allow read: if isAuthenticated() && 
                  resource.data.userId == request.auth.uid;
    }
    
    // Users collection rules (user profiles)
    match /users/{userId} {
      // ðŸ”’ ADMIN: Allow admin to read all user profiles
      allow read: if isAdmin();
      
      // ðŸ‘¤ USERS: Users can read and write their own profile
      allow read, write, create: if isAuthenticated() && 
                                 request.auth.uid == userId;
    }

    // User profiles collection
    match /userProfiles/{userId} {
      // ðŸ”’ ADMIN: Allow admin to read all user profiles
      allow read: if isAdmin();
      
      // ðŸ‘¤ USERS: Users can read and write their own profile
      allow read, write, create: if isAuthenticated() && 
                                 request.auth.uid == userId;
      
      // ðŸšš DRIVERS: Allow authenticated drivers to read customer profiles for contact purposes
      allow read: if isAuthenticated();
    }

    // User addresses collection
    match /userAddresses/{addressId} {
      // ðŸ”’ ADMIN: Allow admin to read all addresses
      allow read: if isAdmin();
      
      // ðŸ‘¤ USERS: Users can manage their own addresses
      allow read, write, create, delete: if isAuthenticated() && 
                                         resource.data.userId == request.auth.uid;
      
      // Allow creation if the user is setting their own ID
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
    }

    // User payment methods collection
    match /userPaymentMethods/{paymentId} {
      // ðŸ”’ ADMIN: Allow admin to read all payment methods
      allow read: if isAdmin();
      
      // ðŸ‘¤ USERS: Users can manage their own payment methods
      allow read, write, create, delete: if isAuthenticated() && 
                                         resource.data.userId == request.auth.uid;
      
      // Allow creation if the user is setting their own ID
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
    }

    // User preferences collection
    match /userPreferences/{userId} {
      // ðŸ”’ ADMIN: Allow admin to read all preferences
      allow read: if isAdmin();
      
      // ðŸ‘¤ USERS: Users can manage their own preferences
      allow read, write, create: if isAuthenticated() && 
                                 request.auth.uid == userId;
    }
    
    // Allow authenticated users to read app configuration and settings
    match /appConfig/{configId} {
      allow read: if isAuthenticated();
    }
    
    // Allow authenticated users to read service information
    match /services/{serviceId} {
      allow read: if isAuthenticated();
    }
    
    // Default deny all other collections unless explicitly allowed
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
